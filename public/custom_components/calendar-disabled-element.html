<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-button/paper-button.html">

<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/bower_components/polymerfire/firebase-auth.html">

<link rel="import" href="/styles/button-styles.html">

<dom-module id="calendar-disabled-element">
    <template>
        <style include="button-styles">
        </style>

        <firebase-auth id="auth" app-name="doctor-appointment-system" status-known="{{statusKnown}}" user="{{user}}"></firebase-auth>

        <firebase-document id="user_contacted_document" app-name="doctor-appointment-system"
                           path="/userContactedOffices/[[user.uid]]/[[officeId]]" data="{{userContactedOffice}}">
        </firebase-document>

        <div hidden="[[loggedIn]]">
            <h3>Vyžadováno přihlášení</h3>
            <p>Pro objednání je vyžadováno přihlášení. Můžete se přihlásit kliknutím na tlačítko níže.</p>
            <paper-button on-tap="_logIn" raised>Přihlásit</paper-button>
        </div>
        <div hidden="[[!computeVerificationVisibility(verificationRequired, loggedIn, patientStatus)]]">
            <h3>Vyžadováno potvrzení</h3>
            <p>Pro objednání je nutné ověření od doktora. Doktor podle Vašich osobních údajů ověří, zda jste
                jeho pacient. Pro ověření prosím
                klikněte na tlačítko níže. Jakmile Vás doktor potvrdí, notifikujeme Vás. Poté se budete moci
                objednat.
            </p>
            <paper-button on-tap="_verifyUser" raised>Požádat o potvrzení</paper-button>
        </div>
        <div hidden="[[computeBlockedVisibility(patientStatus)]]">
            <h3>Přístup zablokován</h3>
            <p>Doktor Vám zablokoval přístup k objednávání. Zřejmě nejste jeho pacientem.</p>
        </div>
        <div hidden="[[computeVerificationRequestSendVisibility(patientStatus)]]">
            <h3>Žádost odeslána</h3>
            <p>Nyní prosím vyčkejte, než Vám doktor povolí přístup.</p>
        </div>

    </template>

    <script>
        Polymer({
            is: 'calendar-disabled-element',

            properties: {
                loggedIn: {
                    type: Boolean,
                    computed: 'computeLoggedInProperty(statusKnown, user)'
                },

                verificationRequired: {
                    type: Boolean,
                    value: true
                },

                disabledCalendar: {
                    type: Boolean,
                    computed: 'computeDisabledCalendarProperty(loggedIn, verificationRequired, patientStatus)',
                    notify: true
                },

                patientStatus: {
                    type: String,
                    value: null,
                    computed: 'computePatientStatusProperty(userContactedOffice)'
                }
            },

            observers: [
                'setVerificationRequired(officeData.manualConfirmation, userId)'
            ],

            _logIn: function () {
                this.fire("show-dialog", {path: "", viewName: "login", open: true});
            },

            setVerificationRequired: function (manualConfirmation, uid) {
                if (manualConfirmation !== undefined && manualConfirmation && uid != undefined) {
                    var ref = this.firebaseApp.database().ref('/officeRegisteredPatients/' + uid);
                    ref.on('value', function (snapshot) {
                        if (snapshot.val() === null) {
                            this.verificationRequired = true;
                        } else {
                            this.verificationRequired = false;
                            ref.off();
                        }
                    }.bind(this));
                } else {
                    this.verificationRequired = false;
                }
            },

            _verifyUser: function () {
                var uid = this.user.uid, officeId = this.officeId,
                    db = this.$.auth.app.database(), objectToSave = {};


                db.ref('/userInfo/' + uid).once('value').then(function (snapshot) {

                    objectToSave['/userContactedOffices/' + uid + '/' + officeId + '/status'] = 'awaitsVerification';
                    objectToSave['/officePatientsToVerify/' + officeId + '/' + uid] = snapshot.val();

                    db.ref('/').update(objectToSave).then(function () {
                        return db.ref('/officeNumberOfNotifications/' + officeId).transaction(function (currentCount) {
                            return (currentCount === null) ? null : currentCount + 1;
                        });
                    })
                }).then(function () {
                    this.fire("show-toast", {text: "Žádost o potvrzení odeslána"});
                }.bind(this), function (error) {
                    this.fire("show-dialog", {
                        path: "", viewName: "genericdialog", open: true,
                        data: {
                            text: 'Při posílání žádosti o potvrzení se vyskytla chyba. Zkuste to prosím znovu.',
                            buttonText: 'Zavřít'
                        }
                    });
                });

                event.stopPropagation ? event.stopPropagation() : (event.cancelBubble = true);
            },

            computeVerificationVisibility: function (verificationRequired, loggedIn, patientStatus) {
                return verificationRequired && loggedIn && !(!!patientStatus);
            },

            computeVerificationRequestSendVisibility: function (patientStatus) {
                return patientStatus !== 'awaitsVerification'
            },

            computeBlockedVisibility: function (patientStatus) {
                return patientStatus !== 'blocked';
            },

            computeLoggedInProperty: function (statusKnown, user) {
                return (statusKnown && !!user);
            },

            computeDisabledCalendarProperty: function (loggedIn, verificationRequired, patientStatus) {
                return (!loggedIn || (verificationRequired && patientStatus !== 'accessed'));
            },

            computePatientStatusProperty: function (userContactedOffice) {
                return (Object.keys(userContactedOffice).length === 1) ? userContactedOffice.status : null;
            }
        });
    </script>
</dom-module>
