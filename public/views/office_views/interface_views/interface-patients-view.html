<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="/bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/communication-icons.html">

<link rel="import" href="/bower_components/polymerfire/firebase-document.html">

<link rel="import" href="/styles/button-styles.html">
<link rel="import" href="/styles/input-styles.html">
<link rel="import" href="/styles/interface-styles.html">


<dom-module id="interface-patients-view">
    <template>
        <style include="interface-styles button-styles input-styles">

            .my-list-item {
                border: 1px solid var(--border-color);
                margin-top: 0.5em;
                position: relative;
            }

            .send-message-icon {
                color: #757576;
                margin-left: 1em;
            }

            /* SEARCH */

            #search-button {
                padding: 0.9em 3em;
            }

            #search-bar {
                margin-bottom: 2em;
            }

            #search-bar input {
                box-sizing: border-box;
                border: 1px solid var(--border-color);
                padding: 0.9em 0.7em;
                font-size: 1em;
                width: 100%;
            }

            #search-bar input::-webkit-input-placeholder {
                color: #aaa;
                font-weight: lighter;
                letter-spacing: 0.02em;
            }

            #search-bar paper-button {
                background-color: var(--app-green-color);
                color: #fff;
                border: none;
            }

            /* MESSAGE CONTAINER */

            .message-container {
                /*position: relative;*/
                background-color: #fbfbfc;
            }

            .subject {
                max-width: 20em;
                margin-bottom: 2em;
            }

            #close-message {
                position: absolute;
                padding: 0.8em 1em 0.8em 1.2em;
                font-size: 0.8em;
                top: 0.5em;
                right: 2em;
            }

            #close-message iron-icon {
                height: 20px;
                width: 20px;
            }

            /* INFO */
            #delete-patient {
                display: block;
                width: 16em;
                font-size: 0.7em;
            }

            .search-button-container{
                text-align: right;
            }

            /* FLEX LAYOUT */
            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
                margin-right: 0.7em;
            }

            /*RESPONSIVE ADDITIONS*/
            @media only screen and (max-width: 1220px) {

                .flex-horizontal-with-ratios {
                    @apply(--layout-vertical);
                }

                .flex-horizontal-with-ratios > div {
                    margin: 0.3em 0;
                }

                .my-list-item {
                    padding-bottom: 0.5em;
                }

                .send-message-icon {
                    position: absolute;
                    top: 1em;
                    right: 1em;
                }

                .label {
                    display: inline-block;
                    margin-right: 0.5em;
                }

                .address-city{
                    margin-left: 3.5em;
                }

                .buttons {
                    padding-top: 0.6em;
                    border-top: 1px solid var(--border-color);
                }
            }

            @media only screen and (max-width: 366px) {

                .buttons > paper-button {
                    display: block;
                    text-align: center;
                    padding: 1em;
                }

                #search-button {
                    width: 100%;
                }
            }

        </style>

        <firebase-document id="verify_document" app-name="doctor-appointment-system" path="/officePatients/[[officeId]]"
                           data="{{officePatients}}">
        </firebase-document>

        <paper-material id="search-bar" class="flex-horizontal-with-ratios my-list-item">
            <div class="flexchild"><input placeholder="Jméno"></div>
            <div class="flexchild "><input placeholder="Adresa"></div>
            <div class="flexchild "><input placeholder="Datum narození"></div>
            <div class="flexchild search-button-container">
                <paper-button id="search-button" raised>
                    <iron-icon icon="icons:search"></iron-icon>
                    Hledat
                </paper-button>
            </div>
        </paper-material>


        <template is="dom-repeat" items="[[patientsArray]]" as="patient">
            <div class="container flex-horizontal-with-ratios my-list-item">

                <div class="flexchild date-of-birth"><span class="label">Jméno:</span>[[computeFullName(patient.name)]]
                </div>

                <div class="flexchild name"><span class="label">Datum narození:</span>[[computeDateOfBirth(patient.dateOfBirth)]]
                </div>

                <div class="flexchild address"><span class="label">Adresa:</span>[[patient.address.street]]
                    <br><div class="address-city">[[patient.address.city]]</div>
                </div>

                <div class="flexchild buttons">

                    <paper-button on-tap="handleDetail" class="details-button">
                        [[computeText(patient.infoOpened)]] detail
                    </paper-button>
                    <a title="poslat zprávu pacientovi" on-tap="handleMessage">
                        <paper-icon-button class="send-message-icon" icon="communication:message"></paper-icon-button>
                    </a>
                </div>
            </div>

            <iron-collapse opened="[[patient.infoOpened]]">
                <div class="collapse-content">
                    TODO Patient info
                    <paper-button id="delete-patient" class="red" raised>Odstranit pacienta</paper-button>
                </div>
            </iron-collapse>

            <iron-collapse opened="[[patient.messageOpened]]">
                <div class="collapse-content message-container">
                    <paper-button id="close-message" class="red" on-tap="handleMessage" raised>Zrušit
                        <iron-icon icon="icons:close"></iron-icon>
                    </paper-button>
                    <h3>Zpráva pacientovi</h3>
                    <paper-input class="subject" label="Předmět zprávy" maxlength="50"></paper-input>
                    <paper-textarea label="Vaše zpráva" char-counter maxlength="2000"></paper-textarea>
                    <paper-button raised>Odeslat</paper-button>
                </div>
            </iron-collapse>
        </template>

    </template>

    <script>
        Polymer({
            is: 'interface-patients-view',

            properties: {
                patientsArray: {
                    type: Array,
                    computed: 'computePatientsArray(officePatients)'
                }

            },

            computeText: function (infoOpened) {
                return (infoOpened) ? "Skrýt" : "Zobrazit";
            },

            handleDetail: function (event) {
                var infoOpened = event.model.patient.infoOpened;
                event.model.set('patient.infoOpened', !infoOpened);
            },

            handleMessage: function (event) {
                var messageOpened = event.model.patient.messageOpened;
                event.model.set('patient.messageOpened', !messageOpened);
            },

            computePatientsArray: function (officePatients) {
                return Object.keys(officePatients).map(function (key) {
                    return {
                        'dateOfBirth': officePatients[key]['dateOfBirth'],
                        'name': officePatients[key]['name'],
                        'address': officePatients[key]['address'],
                        'uid': key
                    }
                });
            },

            computeFullName: function (name) {
                return name.firstName + " " + name.lastName;
            },

            computeDateOfBirth: function (dateOfBirth) {
                return dateOfBirth.date + ". " + dateOfBirth.month + ". " + dateOfBirth.year;
            }

        });
    </script>
</dom-module>
