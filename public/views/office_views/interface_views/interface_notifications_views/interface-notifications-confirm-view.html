<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">

<link rel="import" href="/styles/button-styles.html">
<link rel="import" href="/styles/interface-styles.html">


<dom-module id="interface-notifications-confirm-view">
    <template>
        <style include="interface-styles button-styles">

            .interface-div:hover {
                position: relative;
                box-shadow: 0 5px 60px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .interface-div:not(:first-child) {
                border-top: 1px solid var(--border-color);
            }

            /* FLEX LAYOUT */
            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
                margin-right: 2em;
            }

            .flex2child {
                @apply(--layout-flex);
            }

            .flex3child {
                @apply(--layout-flex);
                text-align: right;
            }

            /*RESPONSIVE ADDITIONS*/
            @media only screen and (max-width: 1150px) {

                .flex-horizontal-with-ratios {
                    @apply(--layout-vertical);
                }

                .flex-horizontal-with-ratios > div {
                    margin: 0.2em 0;
                }

                .flex3child {
                    padding-top: 0.6em;
                    text-align: left;
                }
            }

            @media only screen and (max-width: 300px) {

                .buttons > paper-button {
                    display: block;
                    margin: 0.9em 0;
                    text-align: center;
                    padding: 1.2em;
                }
            }

        </style>

        <firebase-document id="verify_document" app-name="doctor-appointment-system" path="/officePatientsToVerify/[[officeId]]"
                           data="{{officePatientsToVerify}}">
        </firebase-document>

        <template is="dom-repeat" items="[[patientsArray]]" as="patient">
            <div class="container flex-horizontal-with-ratios interface-div">
                <div class="flexchild">[[computeFullName(patient.name)]]</div>
                <div class="flex2child">[[computeAddress(patient.address)]]</div>
                <div class="flex3child buttons">
                    <paper-button raised on-tap="confirmUser" class="confirm-button">Potvrdit</paper-button>
                    <paper-button raised on-tap="dismissUser" class="dismiss-button">Zamítnout</paper-button>
                </div>
            </div>
        </template>

    </template>

    </template>

    <script>
        Polymer({
            is: 'interface-notifications-confirm-view',

            properties: {
                patientsArray: {
                    type: Array,
                    computed: 'computePatientsArray(officePatientsToVerify)'
                }
            },

            confirmUser: function (event) {
                var patientUid = event.model.patient.uid, oid = this.officeId,
                    rootRef = this.$.verify_document.ref.root, objectToSave = {};

                objectToSave['/officePatients/' + oid + '/' + patientUid] = this.officePatientsToVerify[patientUid];
                objectToSave['/officePatientsToVerify/' + oid + '/' + patientUid] = null;
                objectToSave['/userContactedOffices/' + patientUid + '/' + oid + '/status'] = 'accessed';
                // TODO: message to user

                rootRef.update(objectToSave).then(function () {
                    this.fire("show-toast", {text: "Přístup povolen"});
                }.bind(this), function (error) {
//                    TODO: generic error dialog
                    console.log("Error occured in user settings view")
                });
            },

            dismissUser: function (event) {
                var patientUid = event.model.patient.uid;
                console.log(patientUid);
            },

            computePatientsArray: function (obj) {
                return Object.keys(obj).map(function (key) {
                    return {
                        'name': obj[key]['name'],
                        'address': obj[key]['address'],
                        'uid': key
                    }
                });
            },

            computeFullName: function (name) {
                return name.firstName + " " + name.lastName;
            },

            computeAddress: function (address) {
                return address.street + ", " + address.city;
            }
        });
    </script>
</dom-module>
