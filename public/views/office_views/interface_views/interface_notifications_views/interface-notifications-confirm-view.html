<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">

<link rel="import" href="/styles/button-styles.html">
<link rel="import" href="/styles/interface-styles.html">
<link rel="import" href="/styles/patietsAndConfirm.html">

<dom-module id="interface-notifications-confirm-view">
    <template>
        <style include="interface-styles button-styles patietsAndConfirm-styles">

            #not-confirmed-patients {
                text-align: right;
                padding: 1em;
            }

            #not-confirmed-patients a {
                color: var(--app-green-color);
                text-decoration: none;
            }

            #not-confirmed-patients a:hover {
                text-decoration: underline;
            }

            .my-list-item:not(:first-child) {
                border-top: 1px solid var(--border-color);
            }

            .no-patients {
                height: 10em;
                font-size: 1.2em;
                @apply(--layout);
                @apply(--layout-center-center);
            }

        </style>

        <firebase-document id="verify_document" app-name="doctor-appointment-system"
                           path="/officePatientsToVerify/[[officeId]]"
                           data="{{officePatientsToVerify}}">
        </firebase-document>

        <div id="not-confirmed-patients">
            <a href="#">Seznam zamítnutých pacientů</a>
        </div>

        <template is="dom-repeat" items="[[patientsArray]]" as="patient">

            <div class="container flex-horizontal-with-ratios my-list-item">

                <div class="flexchild name"><span class="label">Jméno:</span>
                    [[computeFullName(patient.name)]]
                </div>

                <div class="flexchild date-of-birth"><span class="label">Datum narození:</span>
                    [[computeDateOfBirth(patient.dateOfBirth)]]
                </div>

                <div class="flexchild address"><span class="label">Adresa:</span>[[patient.address.street]]<br>
                    <div class="address-city">[[patient.address.city]]</div>
                </div>

                <div class="flexchild buttons">
                    <paper-button class="confirm-button" on-tap="confirmUser">
                        <iron-icon icon="icons:check"></iron-icon>
                        Potvrdit</paper-button>
                    <paper-button class="dismiss-button">
                        <iron-icon icon="icons:close" on-tap="dismissUser"></iron-icon>
                        Zamítnout</paper-button>
                </div>
            </div>

        </template>

        <div hidden="[[computeIfPatients(patientsArray)]]" class="no-patients">
            <iron-icon icon="info"></iron-icon>
            Žádní pacienti k potvrzení
        </div>

    </template>

    </template>

    <script>
        Polymer({
            is: 'interface-notifications-confirm-view',

            properties: {
                patientsArray: {
                    type: Array,
                    computed: 'computePatientsArray(officePatientsToVerify)'
                }
            },

            confirmUser: function (event) {
                var patientUid = event.model.patient.uid, officeId = this.officeId,
                    db = this.$.verify_document.app.database(), objectToSave = {},
                    rootRef = db.ref('/');

                objectToSave['/officePatients/' + officeId + '/' + patientUid] = this.officePatientsToVerify[patientUid];
                objectToSave['/officePatientsToVerify/' + officeId + '/' + patientUid] = null;
                objectToSave['/userContactedOffices/' + patientUid + '/' + officeId + '/status'] = 'accessed';
                objectToSave['/userNotifications/' + patientUid + '/' + rootRef.push().key] = {
                    'title': 'Verifikace potvrzena',
                    'message': 'Doktor potvrdil, že jste opravdu jeho pacient. Nyní se můžete objednat.',
                    'sender': officeId
                };

                db.ref('/').update(objectToSave).then(function () {
                    db.ref('/userInterfaceInfo/' + patientUid + '/numberOfNotifications').transaction(function (currentCount) {
                        return (currentCount === null) ? null : currentCount + 1;
                    });
                    db.ref('/officeNumberOfNotifications/' + officeId).transaction(function (currentCount) {
                        return (currentCount === null) ? null : currentCount - 1;
                    });
                }).then(function () {
                    this.fire("show-toast", {text: "Přístup povolen"});
                }.bind(this), function (error) {
//                    TODO: generic error dialog
                    console.log("Error occurred in user settings view")
                });
            },

            dismissUser: function (event) {
                var patientUid = event.model.patient.uid, officeId = this.officeId,
                    db = this.$.verify_document.app.database(), objectToSave = {},
                    rootRef = db.ref('/');

                objectToSave['/officeBlockedPatients/' + officeId + '/' + patientUid] = this.officePatientsToVerify[patientUid];
                objectToSave['/officePatientsToVerify/' + officeId + '/' + patientUid] = null;
                objectToSave['/userContactedOffices/' + patientUid + '/' + officeId + '/status'] = 'blocked';
                objectToSave['/userNotifications/' + patientUid + '/' + rootRef.push().key] = {
                    'title': 'Verifikace zamítnuta',
                    'message': 'Je nám líto, ale doktor Vám zablokoval přístup k objednání.',
                    'sender': officeId
                };

                db.ref('/').update(objectToSave).then(function () {
                    db.ref('/userInterfaceInfo/' + patientUid + '/numberOfNotifications').transaction(function (currentCount) {
                        return (currentCount === null) ? null : currentCount + 1;
                    });
                    db.ref('/officeNumberOfNotifications/' + officeId).transaction(function (currentCount) {
                        return (currentCount === null) ? null : currentCount - 1;
                    });
                }).then(function () {
                    this.fire("show-toast", {text: "Pacient zablokován"});
                }.bind(this), function (error) {
//                    TODO: generic error dialog
                    console.log("Error occurred in user settings view during dismiss event.")
                });
            },

            computeIfPatients: function (patientsArray) {
                return patientsArray.length !== 0;
            },

            computePatientsArray: function (officePatientsToVerify) {
                return Object.keys(officePatientsToVerify).map(function (key) {
                    return {
                        'name': officePatientsToVerify[key]['name'],
                        'address': officePatientsToVerify[key]['address'],
                        'dateOfBirth': officePatientsToVerify[key]['dateOfBirth'],
                        'uid': key
                    }
                });
            },

            computeFullName: function (name) {
                return name.firstName + " " + name.lastName;
            },

            computeAddress: function (address) {
                return address.street + ", " + address.city;
            },

            computeDateOfBirth: function (dateOfBirth) {
                return dateOfBirth.date + ". " + dateOfBirth.month + ". " + dateOfBirth.year;
            }

        });
    </script>
</dom-module>
