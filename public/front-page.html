<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-scroll-header-panel/demo/sample-content.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">


<link rel="import" href="dialog_views/registration_view.html">
<link rel="import" href="dialog_views/login_view.html">

<link rel="stylesheet" href="bower_components/paper-styles/demo.css">

<dom-module id="front-page">
    <template>

        <style>
            #emaildialog {
                font-size: medium;
            }
            /*TODO: staré věci potřeba pročistit*/
            paper-scroll-header-panel {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                background-color: var(--paper-grey-200, #eee);

                /* background for toolbar when it is at its full size */
                --paper-scroll-header-panel-full-header: {
                    background-image: url(bower_components/paper-scroll-header-panel/demo/images/bg4.jpg);
                };

                /* background for toolbar when it is condensed */
                --paper-scroll-header-panel-condensed-header: {
                    background-color: var(--paper-light-blue-600);
                };
            }

            paper-toolbar {
                /* custom toolbar height */
                height: 256px;
                background-color: transparent;
                overflow: visible;
            }

            paper-icon-button {
                margin: 0 8px;
                --paper-icon-button-ink-color: white;
            }

            .bottom-text {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);

                font-size: 20px;
                padding-bottom: 10px;
            }

            .subtitle {
                padding-top: 4px;
                font-size: 16px;
                color: #ccc;
            }

            .bookmark {
                position: absolute;
                bottom: -24px;
                right: 24px;
                fill: #4285f4;
                height: 48px;
                width: 48px;
            }

            .content {
                padding: 16px 10px 16px 50px;
            }

            .indent {
                margin-left: 60px;
            }

            .spacer {
                @apply(--layout-flex);
            }
        </style>

        <!-- `keepCondensedHeader` makes the condensed header to not scroll away -->
        <paper-scroll-header-panel condenses keep-condensed-header header-height="256" condensed-header-height="140">

            <paper-toolbar>

                <paper-icon-button icon="arrow-back"></paper-icon-button>
                <div class="spacer"></div>
                <paper-button id="auth_button" raised on-tap="loginButtonListener">Přihlásit</paper-button>
                <paper-button raised on-tap="debugFunction">Jsem lékař</paper-button>
                <div class="bottom indent bottom-text" self-end>
                    <div>Bezcekani.cz</div>
                    <div class="subtitle">Objednáme Vás</div>
                </div>
                <iron-icon class="bottom bookmark" icon="bookmark"></iron-icon>

            </paper-toolbar>

            <div class="content">

                Seznam doktorů

            </div>

        </paper-scroll-header-panel>

        <!--LINK-->
        <firebase-auth id="auth" user="{{user}}" app-name="doctor-appointment-system" provider="password"
                       signed-in="{{signedIn}}"></firebase-auth>

        <paper-dialog id="modal" modal>
            <iron-pages id="ipages" selected="0">
                <login-view id="l_view"></login-view>
                <registration-view id="r_view"></registration-view>
            </iron-pages>
        </paper-dialog>

        <paper-dialog id="emaildialog">
            <p>Na Vaší emailovou adresu byl poslán potvrzovací email.<br>
                Jakmile jej potvrdíte, budete se moci objednat.</p>
            <div class="buttons">
                <paper-button dialog-confirm autofocus>Zavřít</paper-button>
            </div>
        </paper-dialog>

        <paper-toast id="main_toast"></paper-toast>

    </template>

    <script>
        Polymer({
            is: 'front-page',

            properties: {
                signedIn: {
                    type: Boolean,
                    observer: 'authChanged'
                }
            },

            authChanged: function () {
                this.$.auth_button.innerHTML = (this.signedIn ? "Odhlásit" : "Přihlásit");
            },

            loginButtonListener: function () {
                if (this.signedIn) {
                    this.$.auth.signOut().then(function () {
                        /*TODO: find a better way of accessing the shadow DOM properties.
                         This method is searching the IDs globally*/
                        var toast = document.getElementById("main_toast");
                        toast.text = "Odhlášeno";
                        toast.open();
                    });

                } else {
                    this.$.ipages.selected = "0";
                    this.$.modal.toggle();
                }
            },

            debugFunction: function () {
                console.log("debug function: " + this.$.auth.signedIn);
                var user = this.$.auth.user;
                if (!!user) {
                    console.log(user);
//                    user.sendEmailVerification();
                }
//                this.$.emaildialog.toggle();
            },

            createUserWithEmailAndPassword: function (email, pass) {
                this.$.auth.createUserWithEmailAndPassword(email, pass).then(function (user) {
                    user.sendEmailVerification();
                    document.getElementById("emaildialog").toggle();
                }).catch(function (error) {
                    var errorMessage = "";
                    switch (error["code"]) {
                        case "auth/email-already-in-use":
                            errorMessage = "Účet s touto emailovou adresou již existuje";
                            break;
                        default:
                            errorMessage = error["code"];
                    }
                    document.getElementById("r_view").errorMessage = errorMessage;
                    document.getElementById("modal").toggle();
                });
            },

            signInWithEmailAndPassword: function (email, pass) {
                this.$.auth.signInWithEmailAndPassword(email, pass).then(function () {
                    var toast = document.getElementById("main_toast");
                    toast.text = "Přihlášeno";
                    toast.open();
                }).catch(function (error) {
                    var errorMessage = "";
                    switch (error["code"]) {
                        case "auth/wrong-password":
                            errorMessage = "Špatné heslo";
                            break;
                        case "auth/user-not-found":
                        case "auth/invalid-email":
                            errorMessage = "Uživatelské jméno nenalezeno";
                            break;
                        default:
                            errorMessage = error["code"];
                    }
                    document.getElementById("l_view").errorMessage = errorMessage;
                    document.getElementById("modal").toggle();
                });
            }
        });
    </script>
</dom-module>